local success, err = pcall(function()
    local players = game:GetService("Players")
    local workspace = game:GetService("Workspace")
    local camera = workspace.CurrentCamera
    local localPlayer = players.LocalPlayer
    local boxesData, lastGunState, lastPrintTime = {}, {}, {}
    local lastGlobalState = false
    local delayprint = 5

    local function createboxes(player)
        if boxesData[player] then return end
        local box = Drawing.new("Square")
        box.Filled = false
        box.Thickness = 1
        box.Color = Color3.fromRGB(255,255,255)
        box.Visible = false

        local text = Drawing.new("Text")
        text.Color = Color3.fromRGB(255,255,255)
        text.Center = true
        text.Outline = true
        text.Visible = false

        boxesData[player] = {box = box, text = text, lastGun = nil, fading = false}
        lastGunState[player] = false
        lastPrintTime[player] = 0
    end

    local function removeboxes(player)
        local d = boxesData[player]
        if d then
            d.box:Remove()
            d.text:Remove()
            boxesData[player] = nil
            lastGunState[player] = nil
            lastPrintTime[player] = nil
        end
    end

    local function hideboxes(player)
        local d = boxesData[player]
        if d then
            d.box.Visible = false
            d.text.Visible = false
        end
    end

    print("check initiate")

    while true do
        local anyHasGun = false
        local list = players:GetChildren()
        local now = os.clock()

        for _, player in pairs(list) do
            if player == localPlayer then
                hideboxes(player)
                continue
            end

            if not boxesData[player] then
                createboxes(player)
            end

            local data = boxesData[player]
            local char = player.Character
            local root = char and char:FindFirstChild("HumanoidRootPart")
            local hum = char and char:FindFirstChildOfClass("Humanoid")

            if not (char and root and hum) then
                hideboxes(player)
                continue
            end

            if hum.Health <= 0 then
                if not data.fading then
                    data.fading = true
                    spawn(function()
                        for i = 1, 30 do
                            data.box.Color = Color3.fromRGB(255 - (i * 8), 255 - (i * 8), 255 - (i * 8))
                            wait(0.01)
                        end
                        removeboxes(player)
                    end)
                end
                continue
            end

            local foundGun, currentGun = false, nil
            for _, container in pairs({player:FindFirstChild("Backpack"), char}) do
                if container then
                    for _, tool in pairs(container:GetChildren()) do
                        if tool:IsA("Tool") then
                            local gunCheck = tool:FindFirstChild("GUNCHECK")
                            if gunCheck and gunCheck:IsA("Script") then
                                foundGun = true
                                currentGun = tool.Name
                                break
                            end
                        end
                    end
                end
                if foundGun then break end
            end

            if foundGun then
                anyHasGun = true

                if (not lastGunState[player] or data.lastGun ~= currentGun) and (now - (lastPrintTime[player] or 0) >= delayprint) then
                    if not lastGunState[player] then
                        print(player.Name .. " got a gun: " .. currentGun)
                    else
                        print(player.Name .. " switched guns to: " .. currentGun)
                    end
                    lastGunState[player] = true
                    data.lastGun = currentGun
                    lastPrintTime[player] = now
                end

                local hrp = root
                local top = hrp.Position + Vector3.new(0, hrp.Size.Y * 1.15, 0)
                local bottom = hrp.Position - Vector3.new(0, hrp.Size.Y, 0)
                local tpos, ont = WorldToScreen(top)
                local bpos, onb = WorldToScreen(bottom)

                if not (ont and onb) then
                    hideboxes(player)
                    continue
                end

                local height = math.abs(tpos.Y - bpos.Y)
                local width = height / 1.5
                local x = tpos.X - width / 2
                local y = tpos.Y

                data.box.Color = Color3.fromRGB(255, 0, 0)
                data.box.Size = Vector2.new(width, height)
                data.box.Position = Vector2.new(x, y)
                data.box.Visible = true

                data.text.Text = player.Name .. " | " .. currentGun
                data.text.Position = Vector2.new(tpos.X, bpos.Y + 15)
                data.text.Visible = true
                data.fading = false
            else
                if lastGunState[player] then
                    if now - (lastPrintTime[player] or 0) >= delayprint then
                        print(player.Name .. " dropped or lost their gun")
                        lastPrintTime[player] = now
                    end
                    lastGunState[player] = false
                    data.lastGun = nil
                end
                hideboxes(player)
            end
        end

        local playerSet = {}
        for _, p in pairs(list) do
            playerSet[p] = true
        end
        for p in pairs(boxesData) do
            if not playerSet[p] then
                removeboxes(p)
            end
        end

        if anyHasGun then
            lastGlobalState = true
        else
            if lastGlobalState then
                print("no player has a gun boohoo")
                lastGlobalState = false
            end
        end

        wait(0.05)
    end
end)

if not success then
    warn("something fked up: " .. tostring(err))
end
